VARIABLE parim_tulemus NUMBER;

BEGIN
SELECT max(voorkeel) INTO :parim_tulemus
FROM lepikult.kandidaadid;
END;
/

PRINT parim_tulemus;


SELECT id, voorkeel, (:parim_tulemus - voorkeel) AS jaab_alla_puntkidega
FROM lepikult.kandidaadid
ORDER BY jaab_alla_puntkidega ASC;

"ID"	        "VOORKEEL"	"JAAB_ALLA_PUNTKIDEGA"
"50301010295"	97	            0
"50206040331"	96	            1
"50109016514"	96	            1
"50208040318"	95	            2
"50206075719"	95	            2
"49606254928"	95	            2
"50304030260"	94	            3
"39604260339"	94	            3
"39505250230"	94	            3
"50205020352"	93	            4
"50201085239"	93	            4
"50211072718"	93	            4
"50209200319"	93	            4
"50206170329"	92	            5
"50203080269"	92	            5
"50207310229"	91	            6
"50206130242"	91	            6
"50204250214"	91	            6
"50208130218"	91	            6
"50212030319"	90	            7
"50203150228"	90	            7   
"50209246032"	90	            7   
"50206050269"	90	            7
"50203164916"	89	            8
"50112120324"	89	            8
"50112050036"	89	            8
"60203202247"	89	            8
"50303246047"	88	            9
"50207150220"	88	            9
"50206114253"	88	            9
"50207170269"	88	            9
"50209080414"	88	            9
"50302112720"	88	            9
"39707186032"	87	            10
"50204020236"	87	            10
"50106140011"	87	            10
"50212030271"	87	            10
"50206264222"	87	            10
"39701090239"	87	            10
"50111192723"	87	            10
"60101080291"	86	            11
"60201314267"	86	            11
"50206052231"	86	            11
"50211090313"	86	            11
"50205113722"	86	            11
"50209290251"	86	            11
"50302270044"	85	            12
"50004156510"	85	            12
"60210130236"	85	            12
"50106036523"	84	            13
"50306280259"	84	            13
"50202286036"	84	            13
"39909180288"	84	            13
"50210280291"	84	            13
"60206214224"	83	            14
"50012076010"	83	            14
"50103234219"	83	            14
"39809120011"	83	            14
"50305074212"	83	            14
"50212240228"	83	            14
"50011180342"	82	            15
"50207152729"	82	            15
"50201260311"	82	            15
"50207174211"	81	            16
"50204230317"	81	            16
"50109135721"	81	            16
"50012152754"	81	            16
"50210250354"	80	            17
"50104014210"	80	            17
"50206060269"	80	            17
"50204280291"	80	            17
"50202192798"	80	            17
"50106120312"	80	            17
"50205254711"	80	            17
"50310290307"	80	            17
"50211140264"	80	            17
"50106164918"	80	            17
"50204096536"	79	            18
"50201160374"	79	            18
"50008026516"	79	            18
"50205050300"	79	            18
"50204190306"	78	            19
"60208300240"	78	            19
"60209216027"	78	            19
"50212150360"	78	            19
"50205082725"	77	            20
"50303180221"	77	            20
"50204260353"	77	            20
"50111230350"	76	            21
"50108214910"	76	            21
"50206024913"	76	            21
"50201144221"	76	            21
"50204140217"	76	            21
"50211170330"	76	            21
"50106164913"	76	            21
"50106220268"	76	            21
"39602226519"	75	            22
"50201080216"	75	            22
"50112186025"	75	            22
"50205300282"	75	            22
"39912042746"	75	            22
"50209050231"	75	            22
"50112145239"	75	            22
"50207266523"	74	            23
"50205262767"	74	            23
"50106070014"	74	            23
"50208090262"	74	            23
"50201224213"	74	            23
"60201080016"	74	            23
"50208220220"	73	            24
"50112140213"	73	            24
"50208180314"	72	            25
"50203264233"	72	            25
"50107310225"	72	            25
"50104073717"	72	            25
"50208110010"	72	            25
"39911260212"	72	            25
"60108300221"	72	            25
"50111120217"	72	            25
"50209182228"	72	            25
"50112056542"	72	            25
"49906260259"	72	            25
"60004246532"	71	            26
"50012292255"	71	            26
"50202230315"	71	            26
"50205050338"	71	            26
"50111230296"	71	            26
"50203240221"	70	            27
"50209052748"	70	            27
"49901190300"	70	            27
"50002050247"	70	            27
"39902062745"	70	            27
"60209210326"	69	            28
"50106070285"	69	            28
"50108282739"	69	            28
"50212016517"	69	            28
"50208274211"	69	            28
"50306130349"	68	            29
"50208160288"	68	            29
"39705142760"	68	            29
"50112264225"	68	            29
"50208280251"	67	            30
"50209094222"	67	            30
"60105060298"	67	            30
"50206074232"	67	            30
"50208130226"	67	            30
"50106010331"	67	            30
"50110262712"	67	            30
"50007170210"	66	            31
"50208170018"	66	            31
"50208243716"	66	            31
"50207110394"	66	            31
"50212282725"	65	            32
"50302190236"	65	            32
"50208240028"	65	            32
"50211255213"	65	            32
"50203246013"	64	            33
"50206070248"	64	            33
"50111062743"	64	            33
"50201130341"	64	            33
"50203260320"	63	            34
"50204044223"	63	            34
"49201024720"	62	            35
"50210160212"	62	            35
"50109172718"	62	            35
"50301244229"	61	            36
"50112220304"	61	            36
"39610275714"	60	            37
"50002234231"	60	            37
"50207256511"	60	            37
"50210030229"	60	            37
"50207216529"	60	            37
"50206120026"	60	            37
"50106185227"	60	            37
"50208060242"	60	            37
"50203140240"	60	            37
"50211070262"	58	            39
"50209044910"	58	            39
"50106081212"	58	            39
"50209210230"	57	            40
"50206015724"	56	            41
"60106140336"	56	            41
"50205040382"	56	            41
"50112140218"	56	            41
"60110074216"	55	            42
"50107270018"	55	            42
"50304050262"	55	            42
"50109200297"	55	            42
"50209160240"	54	            43
"50203270266"	54	            43
"50012180370"	52	            45
"60206196523"	50	            47
"50101270240"	48	            49
"39908290342"	48	            49
"50209046515"	43	            54
"50302200286"	43	            54
"50111150362"	35	            62


SET SERVEROUTPUT ON

DECLARE
v_aine VARCHAR2(100) := '&aine';
v_nimi VARCHAR2(100) := '&nimi';
v_id NUMBER(11);
v_toid_kokku NUMBER;
v_punktid_kokku NUMBER;
BEGIN
SELECT y.id
INTO   v_id
FROM   lepikult.yliopilased y
WHERE  y.eesnimi || ' ' || y.perenimi = v_nimi;

SELECT COUNT(*), NVL(SUM(parim_tulemus),0)
INTO   v_toid_kokku, v_punktid_kokku
FROM (
SELECT k.too_nr,
MAX(k.punktid) AS parim_tulemus
FROM lepikult.koduylesanded k
JOIN lepikult.oppeained o ON o.kood = k.oppeaine
WHERE  k.yliopilane = v_id
AND (o.kood = v_aine OR o.nimetus LIKE v_aine)
GROUP BY k.too_nr);

DBMS_OUTPUT.PUT_LINE(
'Üliõpilane: ' || v_nimi ||
', Aine: '|| v_aine ||
', Töid: ' || v_toid_kokku ||
', Punktid kokku: ' || v_punktid_kokku
);
END;
/


--tulemus
Üliõpilane: Katrin Kask, Aine: ICA0016, Töid: 3, Punktid kokku: 20